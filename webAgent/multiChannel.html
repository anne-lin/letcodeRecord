<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <meta name="viewport" content="width=device-width">
<!--
    <link rel="stylesheet" href="public_css/bootstrap.min.css"/>
-->
    <script src="public_lib/jquery-2.1.4.min.js"></script>
<!--
    <script src="public_lib/bootstrap.min.js"></script>
-->
    <!--<script src="http://10.130.29.10/JSJaC-master/src/JSJaC.js"></script>-->
    <style>
        #content {
            position: relative;
            width: 800px;
            height: 600px;
            border: 1px solid #eee;
            float: left;
        }

        #title {
            padding: 4px;
            margin-bottom: 10px;
        }

        .btns {
            background-color: white;
            border: 1px solid;
            padding: 0px 10px;
            border-radius: 4px;
        }
        .inputs {
            width: 100px;
            padding: 0px 4px;
        }

        .disabled {
            background-color: grey;
        }

        #quickReply,#smartReply {
            width: 515px;
            height: 600px;
            border: 1px solid #eee;
            float: left;
        }

        #chatMessages {
            width: 400px;
            height: 500px;
            border: 1px solid;
            border-radius: 4px;
            z-index: 1000;
            display: none;
            position: absolute;
            top: 10px;
            background: white;
            left: 400px;
            padding: 10px;
            overflow: auto;
        }
        .chatMessagesShow {
            display: block!important;
        }
         #callInTip{
             z-index: 99999;
             display: none;
             position: fixed;
             top:0;
             bottom: 0;
             left: 0;
             right: 0;
             background-color: rgba(0,0,0,0.5);
             text-align: center;
         }
        #callInTip >div{
           position: absolute;
            top:50%;
            left: 50%;
            transform: translate(-50%,-50%);
            width:300px;
            height: 100px;
            background-color: rgba(255,255,255,1);
            box-shadow: 0 2px 12px 0 rgba(0,0,0,.1);
            border: 1px solid #ebeef5;
            border-radius: 4px;
        }
        #callInTip p{
            text-align: left;
            line-height: 30px;
            text-indent: 10px;
            color: #000000;
            font-weight: bolder;
        }
        #callInTip button{
            width: 80px;
            height: 30px;
            background-color: #5bc1df;
            border: 1px solid #5bc1df;
            border-radius: 4px;
            color:#ffffff;
        }
        .callInTip-btn{
            margin-top: 17px;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="title">
    登录过程:<span id="stateText"></span>
    登录结果：<span id="result"></span>

    entId<input type="text" id="entId" class="inputs" value="2019101101"/>
    agentId<input type="text" id="agentId" class="inputs" value="0402"/>
    password<input type="text" id="password" class="inputs" value="000000"/>
    agentNumber<input type="text" id="agentNumber" class="inputs" value=""/>

    <button class="btns" id="logInBtn">登录</button>
    <button class="btns" id="logOutBtn">登出</button>
    <button class="btns" id="setBusy">置忙</button>
    <button class="btns" id="setReady">置闲</button>
    <button class="btns" id="setNick">昵称</button>
    <span>小休:</span>
    <select id="setAway"></select>
    <button class="btns" id="commonLagBtn">常用语</button>
    <button id="phoneBtn" class="btns">电话图标</button>
    状态：<span id="state"></span>
    <button class="btns" id="loadQuickly">快捷回复</button>
    <button class="btns" id="smartReplyBtn">智能回复</button>
    customId: <input type="text" id="customId"/>
    <button id="getMessages" class="btns">获取聊天记录</button>
    <div id="chatMessages"></div>
</div>

<div id="content"></div>
<div id="smartReply"></div>
<div id="quickReply"></div>
<div id="callInTip">
    <div>
        <p>客户入呼提醒：</p>
        <div class="callInTip-btn">
            <button  id="acceptCall">接听</button>
            <button id="refusedCall">拒绝</button>
        </div>
    </div>
</div>

    <script src="WebAgent.js"></script>
    <script>
        var callInTipSetTime;

        $("#acceptCall").click(()=>{
            $("#callInTip").hide();
            if(callInTipSetTime && typeof callInTipSetTime == "function") {
                clearTimeout(callInTipSetTime);
            }
            WebAgent.imMakeCall('callIn');
        });
        $("#refusedCall").click(()=>{
            $("#callInTip").hide();
            if(callInTipSetTime && typeof callInTipSetTime == "function"){
                clearTimeout(callInTipSetTime);
            }
            WebAgent.refusedCallIn()
        });
        function isLocking() {
            console.log('[CDesk] 当前置忙置闲状态不能使用');
            $("#setBusy").addClass('disabled');
            $("#setReady").addClass('disabled');
            $("#setAway").addClass('disabled');
        }

        function unLocking(s,moreStates) {
            console.log('[CDesk] 当前置闲置忙状态能使用,状态为:'+s);
            $("#setBusy, #setReady,#setAway").removeClass('disabled');
            switch (s){
                case "BUSY":{
                    $("#state").text('已经置忙');
                    $("#phoneBtn").removeClass('disabled');
                    $("#setBusy").addClass('disabled');
                    break;
                }
                case "READY":{
                    $("#state").text('已经置闲');
                    $("#setReady").addClass('disabled');
                    if(moreStates.waState === "READY"){
                        $("#phoneBtn").addClass('disabled');
                    }
                    break;
                }
                case "AWAY":{
                    $("#state").text('小休状态');
                    break;
                }
                default:{

                }
            }
           /* if(s == 'BUSY'){
                $("#state").text('已经置忙');
                $("#phoneBtn").removeClass('disabled');
                $("#setBusy").addClass('disabled');
            }

            if(s == 'READY'){
                $("#state").text('已经置闲');
                $("#setReady").addClass('disabled');
                if(moreStates.waState === "READY"){
                    $("#phoneBtn").addClass('disabled');
                }
            }*/
        }

        var cchatUrl = "WA/theme/cchat.js";
        WebAgent.init({
            useLocal: true,
            callback: function() {
                WebAgent.WaInit({
                    ui: false,
                    sipUseCphone:false,
                    callback:function() {
                        WebAgent.attachModule(cchatUrl, function() {
                            WebAgent.ChatInit({
                                selectorName: "#content",
                                quickReplySelector: "#quickReply",
                                smartReply: "#smartReply",
                                loadBootstrap: false,
                                callback: function() {

                                    $("#phoneBtn").click(()=>{
                                        WebAgent.WaChat.toggle();
                                    });
                                    $("#logInBtn").click(function(){
                                        WebAgent.multiChannelLogin(WebAgent, {
                                            entId        : $("#entId").val(),
                                            agentId      : $("#agentId").val(),
                                            agentPassword: $("#password").val(),
                                            agentNumber  : $("#agentNumber").val(),
                                            waAutoLoginResult: false,
                                            isLocking: isLocking,
                                            unLocking:  unLocking
                                        });
                                    });

                                    // WebAgent.multiChannelLogin(WebAgent, {
                                    //     entId        : "11110000",
                                    //     agentId      : "20181213",
                                    //     agentPassword: "000000",
                                    //     agentNumber  : "sip:1001",
                                    //     waAutoLoginResult: false,
                                    //     isLocking: isLocking,
                                    //     unLocking:  unLocking
                                    // });

                                    WebAgent.ChatToggle();

                                    $("#logOutBtn").click(function() {
                                        WebAgent.multiChannelLogout(()=>{
                                            console.log('登出之后执行的回调')
                                        });
                                        lougoutFlag = true;
                                    });

                                    $("#setBusy").click(function() {
                                        WebAgent.multiChannelState.agentBusy(function(){
                                            console.log('[CDesk] 多渠道能力置忙成功');
                                        },function(){
                                            console.log('[CDesk] 多渠道能力置忙失败');
                                        });
                                    });

                                    $("#setReady").click(function() {
                                        WebAgent.multiChannelState.agentReady(function(){
                                            console.log('[CDesk] 多渠道能力置闲成功');
                                        },function(){
                                            console.log('[CDesk] 多渠道能力置闲失败');
                                        });
                                    });

                                    $("#setNick").click(function () {
                                        WebAgent.setNickName("C7F34F46F02000025DA55E501153109D","8989","webim","yinghan","32131321321");
                                    });


                                    $("#setAway").change(function() {
                                        WebAgent.multiChannelState.agentAway(function(){
                                            console.log('[CDesk] 多渠道能力小休成功');
                                        },function(){
                                            console.log('[CDesk] 多渠道能力小休失败');
                                        },$(this).val());
                                    });

                                    $("#loadQuickly").click(function(){
                                        WebAgent.loadQuickReplyDom("#quickReply");
                                    });

                                    //加载常用语数据
                                    $("#commonLagBtn").click(function() {
                                        WebAgent.loadQuickReplyData();
                                    });

                                    //加载智能回复
                                    $("#smartReplyBtn").click(function(){
                                        WebAgent.loadSmartReplyDom("#smartReply");
                                    });

                                    //获取聊天记录
                                    $("#getMessages").click(function() {
                                        var messages = WebAgent.getChatMsgs($("#customId").val());
                                        var content = "";

                                        if ($("#chatMessages").hasClass("chatMessagesShow")) {
                                            $("#chatMessages").removeClass("chatMessagesShow");
                                        } else {
                                            messages.forEach(function(msg, index) {
                                                content += '<p style="color: blue">' + (msg.direction == "tip" ? "tip" : msg.name) + '</p>'+
                                                        '<p>' + msg.text + '</p>';
                                            });

                                            $("#chatMessages").html(content);
                                            $("#chatMessages").addClass("chatMessagesShow");
                                        }
                                    });

                                    //多渠道登录注册函数
                                    WebAgent.multiRegisterEvent("login", function (data) {
                                        if(data.type == 'loginSuccess') {
                                            console.log("loginSuccess");
                                            var awayStatusList;
                                            if(data.params.awayStatusList){
                                                awayStatusList=data.params.awayStatusList.split(";"),html="";
                                                awayStatusList.forEach(function (item) {
                                                    var data=item.split("=");
                                                    html+="<option value="+data[1]+">"+data[0]+"</option>"
                                                });
                                                $("#setAway").html(html);
                                            }

                                        }
                                        if(data.type == 'loginFail') {
                                            console.log(data.channel + "-loginFail");
//                                            alert("登录失败");
                                        }
                                        $("#result").text(data.type);
                                        $("#stateText").text(data.type);
                                    });

                                    //正在登出多渠道注册函数
                                    WebAgent.multiRegisterEvent("logout", function() {
                                        console.log("[CDesk]:正在登出多渠道");
                                    });

                                    //登录过程提示
                                    WebAgent.multiRegisterEvent("setAgentStateText", function(data) {
                                        $("#stateText").text(data.text);
                                    });

                                    WebAgent.ChatRegisterEvent("openfireDisconnect", function() {
                                        $("#stateText").text("openfire断开");
                                        alert("openfire断开");
                                        WebAgent.multiChannelLogout();
                                        setTimeout(function () {
                                            console.log("执行登入");
                                            WebAgent.multiChannelLogin(WebAgent, {
                                                entId        : $("#entId").val(),
                                                agentId      : $("#agentId").val(),
                                                agentPassword: $("#password").val(),
                                                agentNumber  : $("#agentNumber").val(),
                                                waAutoLoginResult: false,
                                                isLocking: isLocking,
                                                unLocking:  unLocking,
                                            });
                                        },2000);
                                    });

                                    WebAgent.ChatRegisterEvent("butelAjaxError", function(data) {
                                       console.log('butelAjaxError:' + "ButelState:" + data.ButelState + ", AgentStatus:" + data.AgentStatus);
                                    });

                                    WebAgent.ChatRegisterEvent("autoMatchCallback", function() {
                                        console.log("快捷回复");
                                    });

                                    WebAgent.ChatRegisterEvent("openIntellCallback", function() {
                                        console.log("智能回复");
                                    });
                                    WebAgent.ChatRegisterEvent("callIn", function() {
                                       $("#callInTip").show();
                                        callInTipSetTime=setTimeout(function(){
                                            $("#callInTip").hide();
                                             callInTipSetTime="";
                                         },30000)
                                    });

                                    WebAgent.ChatRegisterEvent("newCustomInter", function(data) {
                                        //data类型为对象，属性：userId/userSource/skillGroupId/skillGroupName/isTransfer: 0：正常的新用户进来，
                                        //1：转接到该坐席，导致新用户进来/transferMessage: 转移留言
                                        console.log("新用户到来：" + JSON.stringify(data));
                                    });
                                }
                            });
                        });

                        WebAgent.registerEventHandler(function(data) {
                            if(data.type == "EVENT_SOCKET_ABNORMAL_DISCONNECT") {
                                $("#stateText").text("socket 断开");
                                alert("socket 断开");
                                WebAgent.multiChannelLogout();
                                setTimeout(function () {
                                    console.log("执行登入");
                                    WebAgent.multiChannelLogin(WebAgent, {
                                        entId        : $("#entId").val(),
                                        agentId      : $("#agentId").val(),
                                        agentPassword: $("#password").val(),
                                        agentNumber  : $("#agentNumber").val(),
                                        waAutoLoginResult: false,
                                        isLocking: isLocking,
                                        unLocking:  unLocking,
                                    });
                                },2000);
                            }
                        });

                        WebAgent.registerEventHandler(function(data) {
                            if(data.type == "EVENT_SOCKET_RECONNECTING") {
//                                alert("正在恢复登录，请稍后");
                            }
                        });

                        //自动登录
                        WebAgent.registerResultHandler(function(data) {
                            if(data.type == "autoLogin") {
                                if(data.code == 0) {
                                    console.log("[WebAgent]自动登录成功:" + JSON.stringify(data));
                                    var awayStatus = data && data.ext && data.ext.awayStatus;
                                    WebAgent.multiChannelLogin(WebAgent, {
                                        entId        : data.ext.entId,
                                        agentId      : data.ext.agentId,
                                        agentPassword: data.ext.password,
                                        agentNumber  : "",
                                        waAutoLoginResult: true,
                                        waAutoLoginData: data,
                                        awayStatus: awayStatus,
                                        isLocking: isLocking,
                                        unLocking:  unLocking
                                    });
                                }
                            }
                        });
                        WebAgent.registerStateListener(function(data){
                            console.log("WA状态:" + JSON.stringify(data));
                        });

                    }
                });
            }
        });
    </script>
</body>
</html>
