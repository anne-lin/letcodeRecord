<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <meta name="viewport" content="width=device-width">
    <script src="public_lib/jquery-2.1.4.min.js"></script>
    <style>
        #content{
            width: 700px;
            height: 600px;
            position: relative;
            border: 1px solid #eee;
            margin: 0 auto;
            margin-top: 30px;
        }
    </style>
</head>
<body>
<div>
    <span id="currentStatus">已经置忙</span>
    <button id="setReady" class="btn btn-default">置闲</button>
    <button id="setBusy" class="btn btn-default" disabled>置忙</button>
    <button id="login">登录</button>
    <button id="logOut">登出</button>
</div>
<div id="content"></div>
<script src="WebAgent.js"></script>
<!--<script src="http://123.56.10.62/WebAgent/WebAgent.js"></script>-->
<script src="MultiChannel/ButelAjax.js"></script>
<script>
    $("#setReady").click(function() {
        WebAgent.ChatSetReady();
    });

    $("#setBusy").click(function() {
        WebAgent.ChatSetBusy();
    });

    $("#logOut").click(function() {
        Butel.ajaxFunc("Logout", "logOut");
//        Butel.logout();
        WebAgent.ChatLogout();
    });

    function loginButel(appkey, numbe, uid) {
        Butel.ajaxFunc("Login?appkey=" + appkey + "&numbe=" + numbe + "&uid=" + uid + "&localname=test", "login");
    }

    WebAgent.init({
        useLocal    : true,
        callback    : function () {

            WebAgent.ChatInit({
                selectorName: "#content",
                callback: function () {
                    var appkey,numbe,uuid;

                    //调用apiplus接口返回butel的登录信息
                    $.ajax({
                        url: "http://101.201.65.174:9080/apiplus/webChatData/getAgentButel",
                        type: "post",
                        dataType: "json",
                        data: {
//                    entId: "404",
//                    agentId: "7777"
                            entId: "503",
                            agentId: "2222"
                        },
                        success: function(data) {
                            switch(data.code) {
                                case "000":
                                    $("#login").click(function() {
                                        WebAgent.ChatLogin({
//                                   entId   : "404",
//                                   agentId : "7777",
                                            entId   : "503",
                                            agentId : "2222",
                                            password: "1"
                                        });
                                    });
                                    appkey = data.msg.appkey;
                                    numbe = data.msg.numbe.replace("btl:","");
                                    uuid = data.msg.uuid;
                                    console.log("appkey:" + appkey + ",numbe:" + numbe + ",uuid:" + uuid);
                                    break;
                                case "001":
                                    console.warn("参数为空");
                                    break;
                                case "002":
                                    console.warn("没有该坐席信息");
                                    break;
                                case "003":
                                    console.warn("数据库操作异常");
                                    break;
                                default :
                                    break;
                            }
                        }
                    });

                    WebAgent.ChatToggle();

                    //登录成功
                    WebAgent.ChatRegisterEvent("loginCallback", function() {
                        console.log("chat 登录成功");
//                console.log("appkey:" + appkey + ",numbe:" + numbe + ",uuid:" + uuid);
                        loginButel(appkey, numbe, uuid);
//                loginButel("75cbefe71bd3474fa08755058261a5f9", "45018125", "1101795");
//                Butel.login("75cbefe71bd3474fa08755058261a5f9", "45018125", "1101795");
                    });

                    //置忙成功回调
                    WebAgent.ChatRegisterEvent('busyCallback',function(){
                        console.log('[CCODMultiChanel] 置忙IM成功');
                        $("#currentStatus").text("已经置忙");
                        $("#setReady").prop("disabled", false);
                        $("#setBusy").prop("disabled", true);
                    });

                    //置闲成功回调
                    WebAgent.ChatRegisterEvent('readyCallback',function(){
                        console.log('[CCODMultiChanel] 置闲IM成功');
                        $("#currentStatus").text("已经置闲");
                        $("#setReady").prop("disabled", true);
                        $("#setBusy").prop("disabled", false);
                    });


                    WebAgent.ChatRegisterEvent('getButelState',function(data){
                        console.log('[CCODMultiChanel] Butel事件:' + JSON.stringify(data));
                        //坐席振铃
                        if(data.type === 'msgFromWebAgentButelAlerting') {
                            WebAgent.setBusy();
                            $("#setReady").prop("disabled", true);
                            $("#setBusy").prop("disabled", true);
                        }

                        //坐席接通
                        if(data.type === 'msgFromWebAgentButelConnected') {
                            $("#setReady").prop("disabled", true);
                            $("#setBusy").prop("disabled", true);
                        }

                        //坐席发送butel呼叫结束
                        //坐席发送butel呼叫振铃取消，没有接听只振铃就取消了
                        if(data.type === 'msgFromWebAgentButelEnd' || data.type === 'msgFromWebAgentButelAlertingAbort') {
                            console.log('[CCODMultiChanel] Butel呼叫结束,Butel未接听');
                            WebAgent.setReady();
                        }

                        //坐席发送butel呼叫结束,得到butelSessionId
                        if(data.type === 'msgFromWebAgentButelEnd') {
                            console.log("视频挂断得到的butelSessionId:" + JSON.stringify(data.butelSessionId));
                        }
                    });

                    //chat登出成功
                    WebAgent.ChatRegisterEvent("logoutCallback", function() {
                        console.log("chat 登出成功");
                    });
                }
            });
        }
    });
</script>
</body>
</html>