<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>多渠道座席端demo</title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="public_css/font-awesome.min.css"/>
    <link rel="stylesheet" href="demo/demo.css"/>
    <script src="public_lib/jquery-2.1.4.min.js"></script>
</head>
<body>
    <div id="loginPage">
        <h3 style="text-align: center;margin-bottom: 20px">登录界面</h3>
        <form>
            <table class="qn-login-table">
                <tbody>
                <tr>
                    <td>企业编号：</td>
                    <!--<td><input type="text" id="entId" class="qn-input" maxlength="15" value="7766114"/></td>-->
                    <td><input type="text" id="entId" class="qn-input" maxlength="15" value="1212"/></td>
                </tr>
                <tr>
                    <td>坐席工号：</td>
                    <!--<td><input type="text" id="agentId" class="qn-input" maxlength="15" value="123123"/></td>-->
                    <td><input type="text" id="agentId" class="qn-input" maxlength="15" value="1000001771"/></td>
                </tr>
                <tr>
                    <td>坐席密码：</td>
                    <!--<td><input type="password" id="password" class="qn-input" maxlength="15" value="123456"/></td>-->
                    <td><input type="password" id="password" class="qn-input" maxlength="15" value="123456"/></td>
                </tr>
                <tr>
                    <td>坐席分机：</td>
                    <td><input type="text" id="agentNumber" class="qn-input" maxlength="15" /></td>
                </tr>
                </tbody>
            </table>
            <div class="qn-line">
                <button type="button" id="login" class="qn-login-button">登录</button>
            </div>
        </form>
    </div>

    <div id="logined">
        <div id="title">
            状态：<span id="state"></span>
            <button class="btns" id="setBusy">置忙</button>
            <button class="btns" id="setReady">置闲</button>
            <span id="phoneBtn"><i class="fa fa-phone"></i></span>
            <span id="phoneShadow"></span>
            <span id="imBtn"><i class="fa fa-comment"></i></span>
            <span id="btnShadow"></span>
            <button class="btns" id="logOutBtn">登出</button>
        </div>
        <div id="main">
            <div id="content"></div>
        </div>
    </div>

<!--<script src="http://10.130.41.151:9090/WebAgent3.2/WebAgent.js"></script>-->
<!--<script src="http://10.130.41.142/WebAgent3.2/WebAgent.js"></script>-->
    <!--<script src="http://localhost:9090/WA-Agent-3.2/WebAgent.js"></script>-->
    <script src="WebAgent.js"></script>
<script>
    function isLocking() {
        console.log('[CDesk] 当前置忙置闲状态不能使用');
//        $("#setBusy").prop('disabled',true).addClass('disabled');
//        $("#setReady").prop('disabled',true).addClass('disabled');
        $("#btnShadow").show();
    }

    function unLocking(s,moreStates) {
        console.log('[CDesk] 当前置闲置忙状态能使用,状态为:'+s);
        $("#setBusy, #setReady").removeClass('disabled').prop("disabled", false);
        if(s == 'BUSY'){
            $("#state").text('已经置忙');
            $("#phoneShadow").hide();
            $("#setBusy").addClass('disabled').prop('disabled',true);
            $("#btnShadow").hide();
        }
        else{
            $("#state").text('已经置闲');
            $("#setReady").addClass('disabled').prop('disabled',true);
            $("#btnShadow").hide();
            if(moreStates.waState === "READY"){
                $("#phoneShadow").show();
            }
        }
    }

    function reLogin() {
        $("#btnShadow").show();
        $("#loginPage").hide();
        $("#logined").show();
        WebAgent.multiChannelLogin(WebAgent, {
            entId        : $("#entId").val(),
            agentId      : $("#agentId").val(),
            agentPassword: $("#password").val(),
            agentNumber  : $("#agentNumber").val(),
            waAutoLoginResult: false,
            isLocking: isLocking,
            unLocking:  unLocking
        });
        return false;
    }

    //        var cchatUrl = "http://10.130.41.142/WebAgent3.2/WA/theme/cchat.js";
    var cchatUrl = "http://10.130.41.151:9090/WebAgent3.2/WA/theme/cchat.js";

    WebAgent.init({
        useLocal: true,
        callback: function() {
            WebAgent.WaInit({
                ui: false,
                callback:function() {

                    var loginParam = {
                        entId        : $("#entId").val(),
                        agentId      : $("#agentId").val(),
                        agentPassword: $("#password").val(),
                        agentNumber  : $("#agentNumber").val(),
                        waAutoLoginResult: false,
                        waAutoLoginData: null,
                        isLocking: isLocking,
                        unLocking:  unLocking
                    };

//                    var chatInit = false;

                    WebAgent.attachModule(cchatUrl, function() {
                        WebAgent.WaChat.hide();
                        WebAgent.ChatInit({
                            selectorName: "#content",
                            callback: function() {
//                                chatInit = true;
//                                 $("#login").click(function() {
//                                    $("#btnShadow").show();
//                                    $("#loginPage").hide();
//                                    $("#logined").show();
                                    WebAgent.multiChannelLogin(WebAgent, loginParam);
//                                });

                                $("#logOutBtn").click(function() {
                                    WebAgent.multiChannelLogout();
                                });

                                $("#setBusy").click(function() {
                                    WebAgent.multiChannelState.agentBusy(function(){
                                        console.log('[CDesk] 多渠道能力置忙成功');
                                    },function(){
                                        console.log('[CDesk] 多渠道能力置忙失败');
                                    });
                                });

                                $("#setReady").click(function() {
                                    WebAgent.multiChannelState.agentReady(function(){
                                        console.log('[CDesk] 多渠道能力置闲成功');
                                    },function(){
                                        console.log('[CDesk] 多渠道能力置闲失败');
                                    });
                                });

                                //多渠道登录注册函数
                                WebAgent.multiRegisterEvent("login", function (data) {
                                    if(data.type == 'loginSuccess') {
                                        console.log(data);
                                        $("#btnShadow").show();
                                        $("#loginPage").hide();
                                        $("#logined").show();
                                        $("#btnShadow").hide();
                                        $("#phoneBtn").click(function() {
                                            WebAgent.WaChat.toggle();
                                        });
                                        $("#imBtn").click(function() {
                                            WebAgent.ChatToggle();
                                        });
                                    }
                                    if(data.type == 'loginFail') {
                                        console.log(data.channel + "-loginFail");
                                        alert("登录失败");
                                    }
                                    $("#result").text(data.type);
                                    $("#btnShadow").text(data.type);
                                });

                                //正在登出多渠道注册函数
                                WebAgent.multiRegisterEvent("logout", function() {
                                    console.log("[CDesk]:正在登出多渠道");
                                    $("#loginPage").show();
                                    $("#logined").hide();
                                    WebAgent.WaChat.hide();
                                });

                                //登录过程提示
                                WebAgent.multiRegisterEvent("setAgentStateText", function(data) {
                                    $("#btnShadow").text(data.text);
                                });

                                WebAgent.ChatRegisterEvent("openfireDisconnect", function() {
                                    $("#btnShadow").show();
                                    $("#btnShadow").html("正在恢复，长时间未恢复请<a href='#' id='reLogin' onclick='reLogin()'>重试</a>");
                                });

                                WebAgent.ChatRegisterEvent("butelAjaxError", function(data) {
                                    $("#btnShadow").show();
                                    $("#btnShadow").html("正在恢复，长时间未恢复请<a href='#' id='reLogin' onclick='reLogin()'>重试</a>");
                                });
                            }
                        });
                    });

                    WebAgent.registerEventHandler(function(data) {
                        if(data.type == "EVENT_SOCKET_ABNORMAL_DISCONNECT") {
                            $("#btnShadow").show();
                            $("#btnShadow").html("正在恢复，长时间未恢复请<a href='#' id='reLogin' onclick='reLogin()'>重试</a>");
                        }
                    });

                    WebAgent.registerEventHandler(function(data) {
                        if(data.type == "EVENT_SOCKET_RECONNECTING") {
                            alert("正在恢复登录，请稍后");
                        }
                    });

                    //自动登录
                    WebAgent.registerResultHandler(function(data) {
                        if(data.type == "autoLogin") {
                            if(data.code == 0) {
                                console.log("[WebAgent]自动登录成功:" + JSON.stringify(data));
                                var awayStatus = data && data.ext && data.ext.awayStatus;

                                loginParam.waAutoLoginResult = true;
                                loginParam.waAutoLoginData = data;
                                loginParam.awayStatus = awayStatus;
                                WebAgent.multiChannelAutoLogin(WebAgent, loginParam);
//                                chatInit && WebAgent.multiChannelLogin(WebAgent, loginParam);
                            }
                        }
                    });
                }
            });
        }
    });

</script>
</body>
</html>
